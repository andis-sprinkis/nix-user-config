#!/usr/bin/env sh

cmd_menu=""
[ "$WAYLAND_DISPLAY" ] && cmd_menu="wmenu -p 'Open with:'"
[ "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ] && cmd_menu="dmenu -p 'Open with:'"
[ "$cmd_menu" ] || exit "1"

# dir_appimage="${APPIMAGE_BIN_HOME:-$HOME/.local/opt/appimage}"
# cmd_inc_appimage=""
# [ -d "$dir_appimage" ] && cmd_inc_appimage="(stest -flx \"${dir_appimage}/\" | awk '{ print \"${dir_appimage}/\"\$0 }' | sort -u);"

cmd_inc_bin_path="(stest -flx \$(echo \$PATH | tr : ' ')"

cmd_applications_menu="(cat; ${cmd_inc_bin_path} | sort -u)) | ${cmd_menu}"

killall -u "$(whoami)" "$cmd_menu" 2> "/dev/null"

cmd_args="$(\
  j4-dmenu-desktop \
  --no-generic \
  --skip-i3-exec-check \
  --display-binary \
  --term-mode="custom" \
  --term="${TERMINAL} -e {cmdline@}" \
  --dmenu="$cmd_applications_menu" \
  --no-exec \
  2> "/dev/null" \
)"

[ "$cmd_args" ] || exit

cmd=""
for a in $cmd_args; do
  arg="$a"
  arg="${arg#"'"}"
  arg="${arg%"'"}"
  cmd="${cmd:+$cmd }${arg}"
done

echo "$cmd" | grep -q "^${TERMINAL} -e " && {
  $cmd "$*" 1> "/dev/null" 2> "/dev/null" & disown
  exit
}

echo "$cmd" | grep -q "^/bin/sh -c " || {
  $cmd "$*" 1> "/dev/null" 2> "/dev/null" & disown 
  exit
}

cmd="${cmd#"/bin/sh -c "}"

echo "$cmd" | grep -iq '^.*.\.appimage$' && {
  $cmd "$*" 1> "/dev/null" 2> "/dev/null" & disown
  exit
}

$TERMINAL -e $cmd "$*" 1> "/dev/null" 2> "/dev/null" & disown
