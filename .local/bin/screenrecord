#!/usr/bin/env sh
set -eu

msg_usage="$(basename "$0") usage: no arguments OR [--output|--window|--area|--stop] OR [--help|-h]"

case "${1:-""}" in
  --help|-h)
    echo "$msg_usage"
    exit
  ;;
esac

path_dir="${HOME}/scr"
path_out="${path_dir}/$(date "+%s").mp4"

if [ "${WAYLAND_DISPLAY:-""}" ]; then
  # i3blocks module that checks if wf-recorder is running

  if [ "${1:-""}" = "--stop" ]; then
    set +e
    pkill -SIGINT -f "wf-recorder"
    pkill -SIGINT -f "slurp"
    set -e

    # send signal to i3blocks

    exit "0"
  fi

  if [ "$(pidof "wf-recorder")" ] || [ "$(pidof "slurp")" ]; then
    exit "3"
  fi

  # wf-recorder:
  # --audio=${DEFAULT_SINK}.monitor
  # -c libx264rgb

  case "${1:-""}" in
    "")
    ;;
    --output)
      ptr_coord="$(set +e; slurp -p; set -e)"

      if [ -z "$ptr_coord" ]; then
        exit "0"
      fi

      ptr_coord_x="${ptr_coord%,*}"
      ptr_coord_y="${ptr_coord#*,}"
      ptr_coord_y="${ptr_coord_y% *}"

      output="$(swaymsg -rt get_outputs | jq -r ".[] | select((${ptr_coord_x} >= .rect.x) and (${ptr_coord_x} <= .rect.x + .rect.width) and (${ptr_coord_y} >= .rect.y) and (${ptr_coord_y} <= .rect.y + .rect.height))")"

      rotation_filter=""

      output_transform="$(echo "$output" | jq -r ".transform")"

      case "$output_transform" in
        "180")
          rotation_filter="-F transpose=1"
        ;;
        "90")
          rotation_filter="-F transpose=2"
        ;;
      esac

      output_geometry="$(echo "$output" | jq -r "[([.rect.x, .rect.y] | join(\",\")),([(if .transform == \"90\" or .transform == \"180\" then .rect.width else .rect.height end),(if .transform == \"90\" or .transform == \"180\" then .rect.height else .rect.width end)] | join(\"x\"))] | join(\" \")")"

      echo "$ptr_coord_x"
      echo "$ptr_coord_y"
      echo "$ptr_coord"
      echo "$output"
      echo "$output_geometry"
      echo "$rotation_filter"

      wf-recorder $rotation_filter --geometry "$output_geometry" --file "$path_out"

      # account for scale
    ;;
    --window)
      # require to move the cursor and click in the area ??
      # pointer_coord="$(slurp -p)"

      # get window containing the coord ?
    ;;
    --area)
      # wf-recorder -g "$(slurp)"
    ;;
    *)
      echo "$msg_usage" 1>&2
      exit "1"
    ;;
  esac

  # send signal to i3blocks
fi

if [ "${DISPLAY:-""}" ] && [ -z "${WAYLAND_DISPLAY:-""}" ]; then
  # TODO
  echo "Not implemented in X11" 1>&2
  exit "5"
fi

exit "2"
