#!/usr/bin/env sh
set -eu

msg_usage="$(basename "$0") usage: no arguments OR [--output|--window|--area|--stop] OR [--help|-h]"

case "${1:-""}" in
  --help|-h)
    echo "$msg_usage"
    exit
  ;;
esac

path_dir="${HOME}/scr"
path_out="${path_dir}/$(date "+%s").mp4"

if [ "${WAYLAND_DISPLAY:-""}" ]; then
  # i3blocks module that checks if wf-recorder is running

  if [ "${1:-""}" = "--stop" ]; then
    set +e
    pkill -SIGINT -f "wf-recorder"
    pkill -SIGINT -f "slurp"
    set -e

    if [ "$(pidof "i3blocks")" ]; then
      (sleep "0.5"; pkill "-SIGRTMIN+7" "i3blocks") 1> "/dev/null" 2> "/dev/null" & disown
    fi

    exit "0"
  fi

  if [ "$(pidof "wf-recorder")" ] || [ "$(pidof "slurp")" ]; then
    exit "3"
  fi

  record() {
    # --audio=${DEFAULT_SINK}.monitor

    ptr_coord=""

    case "$1" in
      "area")
        ptr_coord="$(set +e; slurp; set -e)"
      ;;
      "output")
        ptr_coord="$(set +e; slurp -p; set -e)"
      ;;
    esac

    if [ -z "$ptr_coord" ]; then
      exit "0"
    fi

    ptr_coord_x="${ptr_coord%,*}"
    ptr_coord_y="${ptr_coord#*,}"
    ptr_coord_y="${ptr_coord_y% *}"

    output="$(swaymsg -rt get_outputs | jq -r ".[] | select((${ptr_coord_x} >= .rect.x) and (${ptr_coord_x} <= .rect.x + .rect.width) and (${ptr_coord_y} >= .rect.y) and (${ptr_coord_y} <= .rect.y + .rect.height))")"

    output_transform="$(echo "$output" | jq -r ".transform")"

    rec_transpose=""

    case "$output_transform" in
      "180")
        rec_transpose="-F transpose=1"
      ;;
      "90")
        rec_transpose="-F transpose=2"
      ;;
    esac

    rec_geometry=""

    case "$1" in
      "area")
        rec_geometry="$ptr_coord"
      ;;
      "output")
        rec_geometry="$(echo "$output" | jq -r "[([.rect.x, .rect.y] | join(\",\")),([.rect.width,.rect.height] | join(\"x\"))] | join(\" \")")"
      ;;
    esac

    if [ "$(pidof "i3blocks")" ]; then
      (sleep "0.5"; pkill "-SIGRTMIN+7" "i3blocks") 1> "/dev/null" 2> "/dev/null" & disown
    fi

    wf-recorder --codec=libx264rgb "$rec_transpose" --geometry="$rec_geometry" --file="$path_out"

    pkill "-SIGRTMIN+7" "i3blocks" 1> "/dev/null" 2> "/dev/null" & disown
  }

  case "${1:-""}" in
    --output)
      record "output"
    ;;
    --window)
    ;;
    --area)
      record "area"
    ;;
    *)
      echo "$msg_usage" 1>&2
      exit "1"
    ;;
  esac
fi

if [ "${DISPLAY:-""}" ] && [ -z "${WAYLAND_DISPLAY:-""}" ]; then
  # TODO
  echo "Not implemented in X11" 1>&2
  exit "5"
fi

exit "2"
