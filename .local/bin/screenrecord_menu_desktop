#!/usr/bin/env sh
set -eu

delay_current=""
path_state="${XDG_STATE_HOME-"${HOME}/.local/state"}/screenrecord_menu_desktop"
path_state_delay="${path_state}/delay"
delay_current_str=""

if [ -f "$path_state_delay" ]; then
  delay_current="$(head < "$path_state_delay")"

  if [ "$delay_current" != "0" ]; then
    delay_current_str="${delay_current:+" (${delay_current}s)"}"
  fi
else
  mkdir -p "$path_state"
fi

lines="Set delay${delay_current_str}
All screens
Current screen
Current window
Current workspace
Select area
Select screen
Select window
Select workspace"

options="set_delay
all
output_focused
window_focused
workspace_focused
area
output
window
workspace"

sel_line="$(printf "%s\n" "$lines" | menu_desktop -p "Record screen${delay_current_str}:")"
sel_idx="$(echo "$lines" | grep --line-number -x "$sel_line" | cut -f"1" -d":")"
sel_option="$(echo "$options" | sed "${sel_idx}q;d")"

case "$sel_option" in
  "set_delay")
    options_delay="0
3
5
10
15
30
45
60"

    sel_line="$(set +e; printf "%s\n" "$options_delay" | menu_desktop -p "Set delay in seconds${delay_current_str}:"; set -e)"

    if [ "$sel_line" ]; then
      echo "$sel_line" > "$path_state_delay"
    fi

    exec screenrecord_menu_desktop
  ;;
  *)
    screenrecord "$sel_option" "$delay_current"
  ;;
esac

