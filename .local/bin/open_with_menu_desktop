#!/usr/bin/env sh

cmd=""

cmd_menu=""
[ "$WAYLAND_DISPLAY" ] && cmd_menu="wmenu"
[ "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ] && cmd_menu="dmenu"
[ "$cmd_menu" ] || exit "1"

dir_appimage="${APPIMAGE_BIN_HOME:-$HOME/.local/opt/appimage}"
cmd_inc_appimage=""
[ -d "$dir_appimage" ] && cmd_inc_appimage="stest -flx \"${dir_appimage}/\" | awk '{ print \"${dir_appimage}/\"\$0 }' | sort -u;"

cmd_applications_menu="(cat; ${cmd_inc_appimage}) | ${cmd_menu}"

killall -u "$(whoami)" "$cmd_menu" 2> "/dev/null"

cmd_args="$(j4-dmenu-desktop --no-generic --display-binary --term-mode="custom" --term="{cmdline@}" --dmenu="$cmd_applications_menu" --no-exec 2> "/dev/null")"

[ "$cmd_args" ] || exit "2"

cmd=""
for a in $cmd_args; do
  arg="$a"
  arg="${arg#"'"}"
  arg="${arg%"'"}"
  cmd="${cmd:+$cmd }${arg}"
done

[ "$cmd" ] || exit "2"

$cmd "$@"
