#!/usr/bin/env sh
set -eu

script="$(basename "$0")"
msg_usage="${script} usage: no arguments (same as --all) OR [--all|--output|--window|--area] OR [--help|-h]"

case "${1:-""}" in
  --help|-h)
    echo "$msg_usage"
    exit
  ;;
esac

path_dir="${HOME}/scr"
path_out="${path_dir}/$(date "+%s").png"

mkdir -p "$path_dir"

notify_saved() {
  if [ "$(notify-send "Screenshot saved." "${path_out}" --app-name="${script}" --action="LOCATE=Locate" --wait)" ]; then
    file_manager_desktop "$path_out"
  fi
}

if [ "${WAYLAND_DISPLAY:-""}" ]; then
  if [ "$(pidof "grim")" ] || [ "$(pidof "dulcepan")" ]; then
    exit "3"
  fi

  case "${1:-""}" in
    ""|--all)
      grim "$path_out"
    ;;
    --output)
      grim -o "$(swaymsg -t get_outputs | jq -r '.[] | select(.focused) | .name')" "$path_out"
    ;;
    --window)
      grim -g "$(swaymsg -t get_tree | jq -j '.. | select(.type?) | select(.focused).rect | "\(.x),\(.y) \(.width)x\(.height)"')" "$path_out"
    ;;
    --area)
      dulcepan -f "png" -o "$path_out"
    ;;
    -h|--help)
      echo "$msg_usage"
      exit "0"
    ;;
    *)
      echo "$msg_usage" 1>&2
      exit "1"
    ;;
  esac

  printf '%s' "$path_out" | wl-copy

  notify_saved

  exit "0"
fi

if [ "${DISPLAY:-""}" ] && [ -z "${WAYLAND_DISPLAY:-""}" ]; then
  case "${1:-""}" in
    ""|--all)
      maim -u "$path_out"
    ;;
    --output)
      echo "Not implemented (X11): ${1:-""}" 1>&2
      exit "4"
    ;;
    --window)
      maim -u --window "$(xdotool getactivewindow)" "$path_out"
    ;;
    --area)
      maim -u --select "$path_out"
    ;;
    -h|--help)
      echo "$msg_usage"
      exit "0"
    ;;
    *)
      echo "$msg_usage" 1>&2
      exit "1"
    ;;
  esac

  printf '%s' "$path_out" | xclip -sel "clipboard"

  notify_saved

  exit "0"
fi

case "${1:-""}" in
  -h|--help)
    echo "$msg_usage"
    exit "0"
  ;;
  ""|--all|--output|--window|--area|--stop)
    echo "Must be ran under X11 or Wayland." 1>&2
    exit "2"
  ;;
  *)
    echo "$msg_usage" 1>&2
    exit "1"
  ;;
esac
