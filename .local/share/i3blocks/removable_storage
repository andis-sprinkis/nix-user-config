#!/usr/bin/env sh
set -eu

fstab_mounts="$(set +e; grep -v -e "^#" -e "^$" < "/etc/fstab"; set -e)"
fstab_mounts_mpts="$(echo "$fstab_mounts" | awk '{ print $2 }')"

active_mounts="$(set +e; grep -v -P " \/(sys|run|dev|proc|tmp|var)(/| )" < "/proc/mounts"; set -e)"
active_mounts_mpts="$(echo "$active_mounts" | awk '{ print $2 }')"

rsds_mounts=""
rsds_count="0"

ifs_old="$IFS"; IFS="
"

j="1"
for i in $active_mounts_mpts; do
  if echo "$fstab_mounts_mpts" | grep -xq "$i"; then
    j="$((j + 1))"
    continue
  fi

  rsds_count="$(("$rsds_count" + "1"))"
  rsds_mounts="${rsds_mounts:+"${rsds_mounts}
"}- $(echo "$active_mounts" | sed "${j}q;d")"

  j="$((j + 1))"
done

IFS="$ifs_old"

if [ "$rsds_count" -eq "0" ]; then
  exit "0"
fi

if [ "${BLOCK_BUTTON:-""}" ]; then
  case "$BLOCK_BUTTON" in
    "1"|"3")
      title="Removable storage devices mounted"
      cmd="echo -n \"\033]0;${title}\007\"; echo \"${title}:
${rsds_mounts}\" | ${PAGER}"

      $TERMINAL -e "$SHELL" -c "$cmd" 1>/dev/null 2>/dev/null & disown
    ;;
  esac
fi

case "$rsds_count" in
  "0") 
    exit "0"
  ;;
  "1") 
    echo "$rsds_count storage device"
  ;;
  *)
    echo "$rsds_count storage devices"
  ;;
esac

exit "0"
