#!/usr/bin/env sh

rfkill -rn -o "TYPE" | grep -xq "bluetooth" || exit

BLOCK_BUTTON="${BLOCK_BUTTON:-""}" signal="${signal-""}"
controller_id="" controller_is_on="0" dev_count="0"

controller_id="$(bluetoothctl "list" 2> "/dev/null" | grep "\[default\]" | cut -f2 -d" ")"

[ "$controller_id" ] && {
  dev_count="$(bluetoothctl "devices" "Connected" 2> "/dev/null" | wc -l)"
  bluetoothctl show "$controller_id" 2> "/dev/null" | grep -q "PowerState: on" && controller_is_on="1"
}

[ "$BLOCK_BUTTON" ] && {
  reload() {
    [ "${signal}" ] && {
      (sleep "${1:-0.5}"; pkill "-SIGRTMIN+${signal}" i3blocks) 1> "/dev/null" 2> "/dev/null" & disown
    }
  }

  case "$BLOCK_BUTTON" in
    "1")
      blueman-manager 1> "/dev/null" 2> "/dev/null" & disown
    ;;
    "3")
      case "$controller_is_on" in
        "0")
          rfkill "unblock" "bluetooth" 1> "/dev/null" 2> "/dev/null" & disown
          echo "Enabling Bluetooth..."
          reload "5"
        ;;
        "1")
          rfkill "block" "bluetooth" 1> "/dev/null" 2> "/dev/null" & disown
          echo "Disabling Bluetooth..."
          reload
        ;;
      esac
    ;;
  esac
}

case "$dev_count" in
  "0")
    case "$controller_is_on" in
      "0")
        echo "Bluetooth disabled"
      ;;
      "1")
        echo "Bluetooth enabled"
      ;;
    esac
  ;;
  "1")
    echo "${dev_count} Bluetooth device"
  ;;
  "*")
    echo "${dev_count} Bluetooth devices"
  ;;
esac
