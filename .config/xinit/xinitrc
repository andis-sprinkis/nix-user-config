#!/usr/bin/env sh

if [ "$(id -u)" -lt 1000 ]; then
  echo "$(basename "$0"): Must not use a system account" 2>&1
  exit 1
fi

path_d_xresources="${XDG_CONFIG_HOME:-$HOME/.config}/xresources"
path_f_xresources_common="${path_d_xresources}/common.Xresources"
path_f_xresources_local="${path_d_xresources}/local.Xresources"
path_f_xresources_merged="${path_d_xresources}/.Xresources"
mkdir -p "$path_d_xresources"
true > "$path_f_xresources_merged"
[ -f "$path_f_xresources_common" ] && cat "$path_f_xresources_common" >> "$path_f_xresources_merged"
[ -f "$path_f_xresources_local" ] && cat "$path_f_xresources_local" >> "$path_f_xresources_merged"
xrdb -load "$path_f_xresources_merged"

# TODO: merge the xsettingsd local and common config files value by value
path_d_xsettingsd="${XDG_CONFIG_HOME:-$HOME/.config}/xsettingsd"
path_f_xsettingsd_common="${path_d_xsettingsd}/common.conf"
path_f_xsettingsd_local="${path_d_xsettingsd}/local.conf"
path_f_xsettingsd_merged="${path_d_xsettingsd}/xsettingsd.conf"
mkdir -p "$path_d_xsettingsd"
true > "$path_f_xsettingsd_merged"
[ -f "$path_f_xsettingsd_common" ] && cat "$path_f_xsettingsd_common" >> "$path_f_xsettingsd_merged"
[ -f "$path_f_xsettingsd_local" ] && cat "$path_f_xsettingsd_local" >> "$path_f_xsettingsd_merged"

pid_xsettingsd="$(pidof xsettingsd)"
if [ "$pid_xsettingsd" ]; then 
  kill -HUP "$pid_xsettingsd"
else 
  echo "HERE ${path_f_xsettingsd_merged}"
  xsettingsd --config="$path_f_xsettingsd_merged" &
fi

VBoxClient-all &
xset b off &
xset r rate 165 55 &
xkbcomp -I"${XDG_CONFIG_HOME:-$HOME/.config}/xkb" "${XDG_CONFIG_HOME:-$HOME/.config}/xkb/keymap/kbd" "$DISPLAY" &
[ -z "$(pidof unclutter)" ] && unclutter --timeout 1 --start-hidden &
hsetroot -solid "$(xrdb -get background)" &

pid_picom="$(pidof picom)"
if [ "$pid_picom" ]; then 
  kill -USR1 "$pid_picom" &
else 
  picom -b &
fi

if [ "$(pidof xscreensaver)" ]; then 
  xscreensaver-command --restart &
else
  xscreensaver --no-splash & 
fi

[ -z "$(pidof xss-lock)" ] && xss-lock --ignore-sleep -- xscreensaver-command -lock &

if [ "$(pidof i3)" ]; then 
  i3-msg restart
else
  exec i3
fi
