#!/usr/bin/env sh

if [ "$(id -u)" -lt 1000 ]; then
  echo "$(basename "$0"): Must not use a system account" 2>&1
  exit 1
fi

xrdb -load "${XDG_CONFIG_HOME:-$HOME/.config}/xresources/common.Xresources"
pathf_xresources_local="${XDG_CONFIG_HOME:-$HOME/.config}/xresources/local.Xresources"
[ -f "$pathf_xresources_local" ] && xrdb -override "$pathf_xresources_local"

# TODO: merge the xsettingsd local and common config files value by value
pathd_xsettingsd="${XDG_CONFIG_HOME:-$HOME/.config}/xsettingsd"
pathf_xsettingsd_common="${pathd_xsettingsd}/common.conf"
pathf_xsettingsd_local="${pathd_xsettingsd}/local.conf"
pathf_xsettingsd_merged="${pathd_xsettingsd}/xsettingsd.conf"
mkdir -p "$pathd_xsettingsd"
true > "$pathf_xsettingsd_merged"
[ -f "$pathf_xsettingsd_common" ] && cat "$pathf_xsettingsd_common" >> "$pathf_xsettingsd_merged"
[ -f "$pathf_xsettingsd_local" ] && cat "$pathf_xsettingsd_local" >> "$pathf_xsettingsd_merged"

pid_xsettingsd="$(pidof xsettingsd)"
if [ "$pid_xsettingsd" ]; then 
  kill -HUP "$pid_xsettingsd"
else 
  echo "HERE ${pathf_xsettingsd_merged}"
  xsettingsd -c "$pathf_xsettingsd_merged" &
fi

VBoxClient-all &
xset b off &
xset r rate 165 55 &
xkbcomp -I"${XDG_CONFIG_HOME:-$HOME/.config}/xkb" "${XDG_CONFIG_HOME:-$HOME/.config}/xkb/keymap/kbd" "$DISPLAY" &
[ -z "$(pidof unclutter)" ] && unclutter --timeout 1 --start-hidden &
hsetroot -solid "$(xrdb -get background)" &

pid_picom="$(pidof picom)"
if [ "$pid_picom" ]; then 
  kill -USR1 "$pid_picom" &
else 
  picom -b &
fi

if [ "$(pidof xscreensaver)" ]; then 
  xscreensaver-command --restart &
else
  xscreensaver --no-splash & 
fi

[ -z "$(pidof xss-lock)" ] && xss-lock --ignore-sleep -- xscreensaver-command -lock &

if [ "$(pidof i3)" ]; then 
  i3-msg restart
else
  exec i3
fi
